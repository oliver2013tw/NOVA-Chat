<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nova Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400;1,600&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:        #080810;
  --bg2:       #0f0f1a;
  --surface:   #13131f;
  --surface2:  #1a1a2a;
  --surface3:  #21213a;
  --border:    rgba(120,120,255,0.08);
  --border2:   rgba(120,120,255,0.16);
  --glow:      rgba(130,100,255,0.12);
  --accent:    #a78bfa;
  --accent2:   #818cf8;
  --accent-d:  rgba(167,139,250,0.12);
  --accent-d2: rgba(167,139,250,0.06);
  --text:      #e2e0f0;
  --text-2:    #9896b0;
  --text-3:    #50506a;
  --me-bg:     linear-gradient(135deg,#7c3aed,#6d28d9);
  --them-bg:   #1a1a2a;
  --green:     #4ade80;
  --red:       #f87171;
  --r:         20px;
}

*,*::before,*::after { box-sizing:border-box; margin:0; padding:0 }

body {
  font-family:'Inter',sans-serif;
  background:var(--bg);
  color:var(--text);
  height:100dvh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* Animated bg */
body::before {
  content:'';
  position:fixed; inset:0;
  background:
    radial-gradient(ellipse 60% 50% at 20% 0%, rgba(109,40,217,0.08) 0%, transparent 60%),
    radial-gradient(ellipse 50% 40% at 80% 100%, rgba(99,102,241,0.07) 0%, transparent 60%);
  pointer-events:none; z-index:0;
}

body::after {
  content:'';
  position:fixed; inset:0;
  background-image:
    linear-gradient(rgba(120,120,255,0.025) 1px, transparent 1px),
    linear-gradient(90deg, rgba(120,120,255,0.025) 1px, transparent 1px);
  background-size:48px 48px;
  pointer-events:none; z-index:0;
}

/* â”€â”€ OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay {
  position:fixed; inset:0;
  background:rgba(8,8,16,0.97);
  backdrop-filter:blur(24px);
  z-index:200;
  display:flex; align-items:center; justify-content:center;
  transition:opacity .4s, transform .4s;
}
.overlay.out {
  opacity:0; pointer-events:none; transform:scale(1.02);
}
/* ensure nick overlay appears above login overlay */
.overlay.nick { z-index:400; }

/* Auth card */
.auth-card {
  position:relative;
  background: linear-gradient(145deg, #13131f, #0f0f1a);
  border:1px solid var(--border2);
  border-radius:28px;
  padding:52px 56px;
  max-width:420px; width:92%;
  text-align:center;
  box-shadow:
    0 0 0 1px rgba(167,139,250,0.05),
    0 32px 80px rgba(0,0,0,0.6),
    inset 0 1px 0 rgba(255,255,255,0.04);
  animation:cardIn .5s cubic-bezier(.22,1,.36,1);
}

@keyframes cardIn {
  from { opacity:0; transform:translateY(32px) scale(.96) }
  to   { opacity:1; transform:translateY(0) scale(1) }
}

/* Glow ring on card */
.auth-card::before {
  content:'';
  position:absolute; inset:-1px;
  border-radius:29px;
  background:linear-gradient(135deg, rgba(167,139,250,0.2), transparent 50%, rgba(99,102,241,0.15));
  z-index:-1;
}

.logo-wrap { margin-bottom:8px }
.logo-icon {
  width:52px; height:52px;
  margin:0 auto 16px;
  background:linear-gradient(135deg,#7c3aed,#4f46e5);
  border-radius:16px;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 8px 24px rgba(124,58,237,0.4);
}
.logo-icon svg { width:24px; height:24px; }

.card-title {
  font-family:'Cormorant Garamond',serif;
  font-size:2.2rem;
  font-style:italic;
  font-weight:600;
  background:linear-gradient(135deg, #e2e0f0, #a78bfa);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  line-height:1.1;
  margin-bottom:6px;
}

.card-sub {
  font-size:.72rem;
  color:var(--text-3);
  letter-spacing:.12em;
  text-transform:uppercase;
  margin-bottom:36px;
}

.google-btn {
  display:flex; align-items:center; justify-content:center; gap:12px;
  width:100%;
  background:#fff;
  border:none; border-radius:14px;
  padding:14px 20px;
  cursor:pointer;
  font-family:'Inter',sans-serif;
  font-size:.88rem; font-weight:600;
  color:#111;
  transition:all .25s;
  box-shadow:0 4px 16px rgba(0,0,0,0.4), 0 1px 0 rgba(255,255,255,0.1);
  position:relative; overflow:hidden;
}
.google-btn::after {
  content:'';
  position:absolute; inset:0;
  background:linear-gradient(135deg,transparent,rgba(0,0,0,0.04));
}
.google-btn:hover { transform:translateY(-2px); box-shadow:0 8px 28px rgba(0,0,0,0.5); }
.google-btn:active { transform:translateY(0); }
.google-btn:disabled { opacity:.6; cursor:not-allowed; transform:none }

.card-hint {
  margin-top:22px;
  font-size:.7rem; color:var(--text-3);
  line-height:1.7;
}

/* Nickname card additions */
.nick-input-field {
  width:100%;
  background:var(--surface2);
  border:1px solid var(--border2);
  border-radius:12px;
  padding:13px 18px;
  color:var(--text);
  font-family:'Inter',sans-serif;
  font-size:.9rem;
  outline:none;
  transition:border-color .2s, box-shadow .2s;
  text-align:center;
  margin-bottom:10px;
  display:block;
}
.nick-input-field::placeholder { color:var(--text-3) }
.nick-input-field:focus {
  border-color:rgba(167,139,250,0.5);
  box-shadow:0 0 0 3px rgba(167,139,250,0.1);
}

.nick-helper { font-size:.7rem; color:var(--text-3); margin-bottom:22px; line-height:1.6 }

.purple-btn {
  width:100%;
  background:linear-gradient(135deg,#7c3aed,#6d28d9);
  border:none; border-radius:12px;
  padding:13px;
  color:#fff;
  font-family:'Inter',sans-serif;
  font-size:.88rem; font-weight:600;
  cursor:pointer;
  transition:all .25s;
  box-shadow:0 4px 16px rgba(124,58,237,0.35);
  position:relative; overflow:hidden;
}
.purple-btn::after {
  content:'';
  position:absolute; inset:0;
  background:linear-gradient(135deg,rgba(255,255,255,0.1),transparent);
}
.purple-btn:hover { transform:translateY(-1px); box-shadow:0 8px 24px rgba(124,58,237,0.45) }
.purple-btn:active { transform:translateY(0) }

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  display:flex; align-items:center; justify-content:space-between;
  padding:0 28px;
  height:60px;
  border-bottom:1px solid var(--border);
  background:rgba(8,8,16,0.85);
  backdrop-filter:blur(20px);
  position:relative; z-index:50;
  flex-shrink:0;
  gap:12px;
}

.header-left { display:flex; align-items:center; gap:14px }

.h-logo {
  display:flex; align-items:center; gap:10px;
}
.h-logo-icon {
  width:30px; height:30px;
  background:linear-gradient(135deg,#7c3aed,#4f46e5);
  border-radius:9px;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 4px 12px rgba(124,58,237,0.35);
  flex-shrink:0;
}
.h-logo-icon svg { width:14px; height:14px }
.h-logo-name {
  font-family:'Cormorant Garamond',serif;
  font-size:1.3rem;
  font-style:italic;
  font-weight:600;
  background:linear-gradient(135deg,#e2e0f0,#a78bfa);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
}

.h-divider { width:1px; height:18px; background:var(--border2) }

.room-tag {
  font-size:.65rem;
  color:var(--accent);
  letter-spacing:.1em;
  text-transform:uppercase;
  background:var(--accent-d2);
  border:1px solid rgba(167,139,250,0.15);
  border-radius:20px;
  padding:3px 10px;
}

/* ... (å…¶é¤˜ CSS ä¸è®Š - ç‚ºç¯€çœç©ºé–“ç•¥éï¼Œä½†å®Œæ•´æª”æ¡ˆä¸­ä»ä¿ç•™åŸä¾†çš„æ‰€æœ‰æ¨£å¼) ... */

@media(max-width:600px) {
  .header { padding:0 16px }
  .h-logo-name { display:none }
  .h-divider,.room-tag { display:none }
  .messages { padding:14px 14px }
  .input-area { padding:10px 14px 18px }
  .reply-preview,.typing-bar { padding-left:14px; padding-right:14px }
  .auth-card { padding:38px 28px }
}
</style>
</head>
<body>

<!-- â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="overlay" id="ov-login" style="display:flex">
  <div class="auth-card">
    <div class="logo-wrap">
      <div class="logo-icon">
        <svg fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      </div>
    </div>
    <div class="card-title">Nova Chat</div>
    <div class="card-sub">å…¬å…±èŠå¤©å®¤</div>
    <button class="google-btn" id="google-btn">
      <svg width="18" height="18" viewBox="0 0 48 48">
        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
      </svg>
      ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
    </button>
    <p class="card-hint">ç™»å…¥å³ä»£è¡¨ä½ åŒæ„éµå®ˆèŠå¤©å®¤ä½¿ç”¨è¦ç¯„</p>
  </div>
</div>

<!-- â”€â”€ NICK SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="overlay out nick" id="ov-nick" style="display:none">
  <div class="auth-card">
    <div class="logo-wrap">
      <div class="logo-icon">
        <svg fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
    </div>
    <div class="card-title">æ­¡è¿åŠ å…¥</div>
    <div class="card-sub">è¨­å®šä½ çš„æš±ç¨±</div>
    <input class="nick-input-field" id="nick-input" type="text" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±â€¦" maxlength="16" autocomplete="off">
    <p class="nick-helper">æœ€å¤š 16 å€‹å­— Â· ä¹‹å¾Œå¯éš¨æ™‚ä¿®æ”¹</p>
    <button class="purple-btn" id="nick-btn">é€²å…¥èŠå¤©å®¤</button>
  </div>
</div>

<!-- â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header class="header" id="main-header" style="display:none">
  <div class="header-left">
    <div class="h-logo">
      <div class="h-logo-icon">
        <svg fill="none" stroke="#fff" stroke-width="2.5" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      </div>
      <span class="h-logo-name">Nova Chat</span>
    </div>
    <div class="h-divider"></div>
    <div class="room-tag">å…¬å…±èŠå¤©å®¤</div>
  </div>
  <div class="header-right">
    <div class="online-pill">
      <div class="live-dot"></div>
      <span id="online-count">0 äººåœ¨ç·š</span>
    </div>
    <button class="user-btn" id="user-btn">
      <div class="u-av init av0" id="hdr-av">?</div>
      <span id="hdr-nick">â€¦</span>
      <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
    </button>
    <div class="dropdown" id="dropdown" style="display:none">
      <div class="dd-user">
        <div class="u-av init av0" id="dd-av" style="width:34px;height:34px;font-size:.85rem;border:none">?</div>
        <div class="dd-user-info">
          <div class="dd-user-nick" id="dd-nick-label">â€¦</div>
          <div class="dd-user-email" id="dd-email">â€¦</div>
        </div>
      </div>
      <div class="dd-item" id="dd-edit-nick">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
        ä¿®æ”¹æš±ç¨±
      </div>
      <div class="dd-sep"></div>
      <div class="dd-item danger" id="dd-logout">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        ç™»å‡º
      </div>
    </div>
  </div>
</header>

<!-- â”€â”€ MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="messages" id="messages" style="display:none">
  <div class="scroll-btn" id="scroll-btn">
    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
    <div class="unread-dot" id="unread-dot"></div>
  </div>
</div>

<div class="typing-bar" id="typing-bar" style="display:none"></div>

<div class="reply-preview" id="reply-preview">
  <div class="rp-bar"></div>
  <div class="rp-content">
    <div class="rp-name" id="rp-name"></div>
    <div class="rp-text" id="rp-text"></div>
  </div>
  <button class="rp-close" id="rp-close">
    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12"/></svg>
  </button>
</div>

<div class="input-area" id="input-area" style="display:none">
  <div class="input-box">
    <textarea id="msg-input" placeholder="è¼¸å…¥è¨Šæ¯â€¦" rows="1"></textarea>
    <button class="send-btn" id="send-btn">
      <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M22 2 11 13"/><path d="M22 2 15 22 11 13 2 9l20-7z"/></svg>
    </button>
  </div>
</div>

<!-- â”€â”€ CONTEXT MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="ctx-menu" id="ctx-menu">
  <div class="ctx-emojis">
    <span class="ctx-emoji" data-e="ğŸ‘">ğŸ‘</span>
    <span class="ctx-emoji" data-e="â¤ï¸">â¤ï¸</span>
    <span class="ctx-emoji" data-e="ğŸ˜‚">ğŸ˜‚</span>
    <span class="ctx-emoji" data-e="ğŸ˜®">ğŸ˜®</span>
    <span class="ctx-emoji" data-e="ğŸ”¥">ğŸ”¥</span>
    <span class="ctx-emoji" data-e="ğŸ‘">ğŸ‘</span>
  </div>
  <div class="ctx-item" id="ctx-reply">
    <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 0 0-4-4H4"/></svg>
    å›è¦†
  </div>
  <div class="ctx-item" id="ctx-copy">
    <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
    è¤‡è£½æ–‡å­—
  </div>
  <div class="ctx-item danger" id="ctx-del" style="display:none">
    <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6M9 6V4h6v2"/></svg>
    åˆªé™¤è¨Šæ¯
  </div>
</div>

<!-- â”€â”€ NICK EDIT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-bg" id="nick-modal">
  <div class="modal">
    <h3>âœï¸ ä¿®æ”¹æš±ç¨±</h3>
    <input class="nick-input-field" id="modal-nick" type="text" placeholder="æ–°æš±ç¨±â€¦" maxlength="16" autocomplete="off">
    <button class="purple-btn" id="modal-nick-save" style="margin-top:6px">å„²å­˜</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script type="module">
import { initializeApp }   from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth, GoogleAuthProvider,
  signInWithPopup, signInWithRedirect, getRedirectResult,
  signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved,
  onValue, set, remove, serverTimestamp, get, update, onDisconnect
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

/* â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const app  = initializeApp({
  apiKey:            "AIzaSyCOTBvBm2kb8wtcTno8MutWSt7VIi0EDvU",
  authDomain:        "nova-chat-01.firebaseapp.com",
  databaseURL:       "https://nova-chat-01-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:         "nova-chat-01",
  storageBucket:     "nova-chat-01.firebasestorage.app",
  messagingSenderId: "682076092699",
  appId:             "1:682076092699:web:bebef99942aceea37afbbe"
});
const auth = getAuth(app);
const db   = getDatabase(app);

/* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let myUser = null, myNick = '', myUid = '';
let replyingTo = null, ctxTarget = null, ctxKey = null, ctxOwner = null;
let touchTimer = null, unreadCount = 0, atBottom = true, lastDate = '';
let chatInited = false;

const AV = ['av0','av1','av2','av3','av4','av5','av6','av7'];
const $ = id => document.getElementById(id);
const colorFor = uid => AV[uid.split('').reduce((a,c)=>a+c.charCodeAt(0),0) % AV.length];
const fmtTime  = ts  => { const d=new Date(ts); return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0') };
const esc      = s   => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
const provider = new GoogleAuthProvider();
provider.setCustomParameters({ prompt:'select_account' });

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toast(msg, dur=2400) {
  const t = $('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), dur);
}

/* â”€â”€ UI show/hide â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const ovLogin = $('ov-login'), ovNick = $('ov-nick');

function showLogin() {
  // ensure login overlay visible, hide nick overlay
  ovLogin.style.display = 'flex';
  ovLogin.classList.remove('out');
  ovNick.classList.add('out');
  ovNick.style.display = 'none';
  $('main-header').style.display = 'none';
  $('messages').style.display    = 'none';
  $('typing-bar').style.display  = 'none';
  $('input-area').style.display  = 'none';
  $('reply-preview').classList.remove('show');
}

function showNickSetup() {
  // hide login entirely to avoid overlap and display nick overlay
  ovLogin.classList.add('out');
  ovLogin.style.display = 'none';
  ovNick.style.display = 'flex';
  ovNick.classList.remove('out');
  // autofocus nickname input a bit later
  setTimeout(() => $('nick-input').focus(), 300);
}

function showChat() {
  ovLogin.classList.add('out'); ovLogin.style.display='none';
  ovNick.classList.add('out'); ovNick.style.display='none';
  $('main-header').style.display = 'flex';
  $('messages').style.display    = 'flex';
  $('typing-bar').style.display  = 'flex';
  $('input-area').style.display  = 'block';
  updateHeader();
  if (!chatInited) { chatInited = true; initChat(); }
  setTimeout(()=> $('msg-input').focus(), 100);
}

/* â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const googleBtnOrig = $('google-btn').innerHTML;

// Google login button
$('google-btn').addEventListener('click', async () => {
  const btn = $('google-btn');
  btn.disabled = true;
  if (isMobile) {
    btn.innerHTML = 'â³ æ­£åœ¨è·³è½‰â€¦';
    try { await signInWithRedirect(auth, provider); }
    catch(e) { toast('ç™»å…¥å¤±æ•—ï¼š'+(e.code||e.message)); btn.disabled=false; btn.innerHTML=googleBtnOrig; }
  } else {
    btn.innerHTML = 'â³ ç™»å…¥ä¸­â€¦';
    try { await signInWithPopup(auth, provider); }
    catch(e) {
      const m = e.code==='auth/popup-blocked' ? 'è«‹å…è¨±ç€è¦½å™¨å½ˆå‡ºè¦–çª—å¾Œé‡è©¦'
              : e.code==='auth/popup-closed-by-user' ? 'è¦–çª—å·²é—œé–‰ï¼Œè«‹é‡è©¦'
              : 'ç™»å…¥å¤±æ•—ï¼š'+(e.code||e.message);
      toast(m); btn.disabled=false; btn.innerHTML=googleBtnOrig;
    }
  }
});

// Central auth state handler
// getRedirectResult first, THEN set up onAuthStateChanged
// This avoids the race condition where onAuthStateChanged fires
// with null before redirect result is processed
(async () => {
  try {
    // try to process redirect result (if any)
    const rr = await getRedirectResult(auth);
    // no special handling here; onAuthStateChanged below will run with user
  } catch(e) {
    if (e.code && e.code !== 'auth/no-current-user') toast('ç™»å…¥å¤±æ•—ï¼š'+e.code);
  }

  onAuthStateChanged(auth, async user => {
    if (!user) { showLogin(); return; }
    myUser = user;
    myUid  = user.uid;

    // hide login overlay (remove any visual overlap)
    try {
      ovLogin.classList.add('out');
      ovLogin.style.display = 'none';
    } catch(_) {}

    // fetch user record to check if nick exists
    try {
      const snap = await get(ref(db, 'users/'+myUid));
      if (!snap.exists() || !snap.val().nick) {
        // if no nick, show nickname setup overlay
        showNickSetup();
      } else {
        myNick = snap.val().nick;
        showChat();
      }
    } catch (e) {
      console.error('user read error', e);
      // fallback to nick setup if DB read fails
      showNickSetup();
    }
  });
})();

/* â”€â”€ Nick setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
$('nick-btn').addEventListener('click', saveNick);
$('nick-input').addEventListener('keydown', e => { if(e.key==='Enter') saveNick(); });

async function saveNick() {
  const n = $('nick-input').value.trim();
  if (!n) { $('nick-input').focus(); return; }
  const btn = $('nick-btn');
  btn.disabled = true;
  const orig = btn.textContent;
  btn.textContent = 'å„²å­˜ä¸­â€¦';
  try {
    myNick = n;
    await set(ref(db,'users/'+myUid), { nick:n, uid:myUid, photo:myUser.photoURL||'' });
    // ensure overlays hidden and show chat
    showChat();
  } catch(e) {
    console.error(e);
    toast('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
    btn.disabled=false; btn.textContent=orig;
  }
}

/* â”€â”€ Header UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateHeader() {
  const cl = colorFor(myUid);
  // header avatar
  const hdrAv = $('hdr-av');
  if (myUser.photoURL) {
    hdrAv.outerHTML = `<img class="u-av" id="hdr-av" src="${esc(myUser.photoURL)}" alt="${esc(myNick[0]||'?')}" onerror="this.outerHTML='<div class=\\"u-av init ${cl}\\" id=\\"hdr-av\\">${esc((myNick[0]||'?').toUpperCase())}</div>'">`;
  } else {
    hdrAv.className=`u-av init ${cl}`; hdrAv.textContent=(myNick[0]||'?').toUpperCase();
  }
  $('hdr-nick').textContent = myNick;
  // dropdown info
  const ddAv = $('dd-av');
  if (myUser.photoURL) {
    ddAv.outerHTML=`<img class="u-av" id="dd-av" src="${esc(myUser.photoURL)}" alt="" style="width:34px;height:34px;border:none" onerror="this.outerHTML='<div class=\\"u-av init ${cl}\\" id=\\"dd-av\\" style=\\"width:34px;height:34px;border:none\\">${esc((myNick[0]||'?').toUpperCase())}</div>'">`;
  } else {
    ddAv.className=`u-av init ${cl}`; ddAv.style.cssText='width:34px;height:34px;border:none'; ddAv.textContent=(myNick[0]||'?').toUpperCase();
  }
  $('dd-nick-label').textContent = myNick;
  $('dd-email').textContent = myUser.email || '';
}

/* â”€â”€ Presence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initChat() {
  const presRef = ref(db,'presence/'+myUid);
  set(presRef, { nick:myNick, uid:myUid, ts:Date.now() });
  onDisconnect(presRef).remove();

  onValue(ref(db,'presence'), snap => {
    $('online-count').textContent = (snap.exists() ? Object.keys(snap.val()).length : 0) + ' äººåœ¨ç·š';
  });

  listenMessages();
  listenTyping();
}

/* â”€â”€ Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function listenMessages() {
  const mRef = ref(db,'messages');
  const buf=[]; let init=true;

  onChildAdded(mRef, snap => {
    const msg = {...snap.val(), _key:snap.key};
    if (init) { buf.push(msg); return; }
    renderMsg(msg);
    if (!atBottom) {
      unreadCount++;
      $('unread-dot').style.display='block';
      $('scroll-btn').classList.add('show');
    }
  });

  onValue(mRef, ()=>{
    if (!init) return; init=false;
    const msgsEl = $('messages');
    msgsEl.innerHTML=`<div class="scroll-btn" id="scroll-btn">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
      <div class="unread-dot" id="unread-dot"></div>
    </div>`;
    buf.forEach(m=>renderMsg(m,true));
    scrollBottom();
    $('scroll-btn').addEventListener('click',()=>{
      scrollBottom(); unreadCount=0;
      $('unread-dot').style.display='none';
      $('scroll-btn').classList.remove('show');
    });
  },{onlyOnce:true});

  onChildChanged(mRef, snap=>renderReactions({...snap.val(),_key:snap.key}));

  onChildRemoved(mRef, snap=>{
    const el=document.querySelector(`.msg-row[data-key="${snap.key}"]`);
    if(el){el.style.cssText+='opacity:0;transform:scale(.95) translateX(10px);transition:all .25s';setTimeout(()=>el.remove(),250);}
  });
}
/* â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderMsg(msg, skip=false) {
  const msgsEl = $('messages');
  if (msg.type==='system') {
    const d=document.createElement('div'); d.className='sys-msg'; d.textContent=msg.text;
    msgsEl.appendChild(d); if(!skip) scrollBottom(); return;
  }
  const isMe = msg.uid===myUid;
  const ts   = msg.ts||Date.now();
  const ds   = new Date(ts).toLocaleDateString('zh-TW',{month:'long',day:'numeric'});

  if (ds!==lastDate) {
    lastDate=ds;
    const dd=document.createElement('div'); dd.className='date-div'; dd.textContent=ds;
    msgsEl.appendChild(dd);
  }

  const cl  = colorFor(msg.uid||'');
  const let0= (msg.nick||'?')[0].toUpperCase();
  const photo= isMe?(myUser.photoURL||''):(msg.photo||'');

  const avHTML = photo
    ? `<img class="av" src="${esc(photo)}" alt="${let0}" onerror="this.outerHTML='<div class=\\"av ${cl}\\">${let0}</div>'">`
    : `<div class="av ${cl}">${let0}</div>`;

  const replyHTML = msg.replyTo
    ? `<div class="reply-ref"><div class="reply-ref-name">${esc(msg.replyTo.nick)}</div><div class="reply-ref-text">${esc(msg.replyTo.text)}</div></div>`
    : '';

  const row=document.createElement('div');
  row.className=`msg-row ${isMe?'me':'them'}`;
  row.dataset.key=msg._key;
  row.innerHTML=`
    ${avHTML}
    <div class="msg-col">
      ${!isMe?`<div class="msg-name">${esc(msg.nick||'?')}</div>`:''}
      <div class="bubble-row">
        <div class="bubble"
          data-key="${esc(msg._key)}"
          data-uid="${esc(msg.uid||'')}"
          data-nick="${esc(msg.nick||'')}"
          data-text="${esc(msg.text)}"
        >${replyHTML}${esc(msg.text)}</div>
        <div class="bubble-time">${fmtTime(ts)}</div>
      </div>
      <div class="reactions-bar" id="rb-${esc(msg._key)}"></div>
    </div>`;

  const bub = row.querySelector('.bubble');
  bub.addEventListener('contextmenu', onCtx);
  bub.addEventListener('touchstart', e=>{
    touchTimer=setTimeout(()=>showCtx(e.touches[0].clientX,e.touches[0].clientY,bub),480);
  },{passive:true});

  msgsEl.appendChild(row);
  renderReactions(msg);
  if(!skip) scrollBottom();
}

/* â”€â”€ Reactions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderReactions(msg) {
  const bar=$('rb-'+msg._key); if(!bar) return;
  const counts={}, mine={};
  Object.entries(msg.reactions||{}).forEach(([uid,e])=>{ counts[e]=(counts[e]||0)+1; if(uid===myUid)mine[e]=true; });
  bar.innerHTML='';
  Object.entries(counts).forEach(([e,n])=>{
    const c=document.createElement('div');
    c.className='r-chip'+(mine[e]?' mine':'');
    c.innerHTML=`<span>${e}</span><span>${n}</span>`;
    c.addEventListener('click',()=>toggleRx(msg._key,e));
    bar.appendChild(c);
  });
}

async function toggleRx(key, emoji) {
  const r=ref(db,`messages/${key}/reactions/${myUid}`);
  const s=await get(r);
  if(s.exists()&&s.val()===emoji) await remove(r); else await set(r,emoji);
}
/* â”€â”€ Typing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let typTO;
function listenTyping() {
  $('msg-input').addEventListener('input',()=>{
    set(ref(db,'typing/'+myUid),myNick);
    clearTimeout(typTO); typTO=setTimeout(()=>remove(ref(db,'typing/'+myUid)),2500);
  });
  onValue(ref(db,'typing'),snap=>{
    const tb=$('typing-bar'); if(!tb)return;
    if(!snap.exists()){tb.innerHTML='';return;}
    const names=Object.entries(snap.val()).filter(([u])=>u!==myUid).map(([,n])=>n);
    if(!names.length){tb.innerHTML='';return;}
    tb.innerHTML=`<div class="t-dots"><div class="t-dot"></div><div class="t-dot"></div><div class="t-dot"></div></div>${esc(names.slice(0,3).join('ã€'))} æ­£åœ¨è¼¸å…¥â€¦`;
  });
}

/* â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function sendMsg() {
  const inp=$('msg-input'), text=inp.value.trim(); if(!text)return;
  const snap=await get(ref(db,'users/'+myUid)); if(snap.exists()) myNick=snap.val().nick;
  const payload={uid:myUid,nick:myNick,photo:myUser.photoURL||'',text,ts:serverTimestamp()};
  if(replyingTo){payload.replyTo=replyingTo;clearReply();}
  push(ref(db,'messages'),payload);
  inp.value=''; inp.style.height='';
  remove(ref(db,'typing/'+myUid));
}
$('send-btn').addEventListener('click',sendMsg);
$('msg-input').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}});
$('msg-input').addEventListener('input',()=>{ const i=$('msg-input'); i.style.height='auto'; i.style.height=Math.min(i.scrollHeight,120)+'px'; });

/* â”€â”€ Context Menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function onCtx(e){e.preventDefault();showCtx(e.clientX,e.clientY,e.currentTarget);}
function showCtx(x,y,bub){
  ctxTarget=bub; ctxKey=bub.dataset.key; ctxOwner=bub.dataset.uid;
  $('ctx-del').style.display=ctxOwner===myUid?'flex':'none';
  const m=$('ctx-menu');
  m.style.left=Math.min(x,innerWidth-175)+'px';
  m.style.top=Math.min(y,innerHeight-180)+'px';
  m.classList.add('show');
}
document.addEventListener('click',()=>$('ctx-menu').classList.remove('show'));
document.addEventListener('touchend',()=>clearTimeout(touchTimer));
document.addEventListener('touchmove',()=>clearTimeout(touchTimer),{passive:true});

document.querySelectorAll('.ctx-emoji').forEach(btn=>{
  btn.addEventListener('click',()=>{ if(ctxKey) toggleRx(ctxKey,btn.dataset.e); });
});
$('ctx-reply').addEventListener('click',()=>{
  if(!ctxTarget)return;
  replyingTo={nick:ctxTarget.dataset.nick,text:ctxTarget.dataset.text};
  $('rp-name').textContent='å›è¦† '+replyingTo.nick;
  $('rp-text').textContent=replyingTo.text;
  $('reply-preview').classList.add('show');
  $('msg-input').focus();
});
$('ctx-copy').addEventListener('click',()=>{
  if(!ctxTarget)return;
  navigator.clipboard.writeText(ctxTarget.dataset.text).then(()=>toast('å·²è¤‡è£½'));
});
$('ctx-del').addEventListener('click',async()=>{
  if(!ctxKey||ctxOwner!==myUid)return;
  await remove(ref(db,'messages/'+ctxKey));
  toast('è¨Šæ¯å·²åˆªé™¤');
});
$('rp-close').addEventListener('click',clearReply);
function clearReply(){ replyingTo=null; $('reply-preview').classList.remove('show'); }

/* â”€â”€ Scroll â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function scrollBottom(){ const m=$('messages'); if(m) m.scrollTop=m.scrollHeight; }
document.addEventListener('scroll',()=>{}, {passive:true});
$('messages').addEventListener('scroll',()=>{
  const m=$('messages');
  atBottom=m.scrollHeight-m.scrollTop-m.clientHeight<80;
  if(atBottom){ $('scroll-btn')?.classList.remove('show'); unreadCount=0; if($('unread-dot'))$('unread-dot').style.display='none'; }
},{passive:true});
/* â”€â”€ Dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
$('user-btn').addEventListener('click',e=>{
  e.stopPropagation();
  const dd=$('dropdown');
  dd.style.display=dd.style.display==='none'?'block':'none';
});
document.addEventListener('click',()=>{ $('dropdown').style.display='none'; });

$('dd-edit-nick').addEventListener('click',()=>{
  $('modal-nick').value=myNick;
  $('nick-modal').classList.add('show');
  setTimeout(()=>$('modal-nick').focus(),100);
});
$('modal-nick-save').addEventListener('click',async()=>{
  const n=$('modal-nick').value.trim(); if(!n) return;
  await update(ref(db,'users/'+myUid),{nick:n});
  myNick=n; $('hdr-nick').textContent=n; $('dd-nick-label').textContent=n;
  $('nick-modal').classList.remove('show');
  toast('æš±ç¨±å·²æ›´æ–° âœ¨');
});
$('modal-nick').addEventListener('keydown',e=>{if(e.key==='Enter')$('modal-nick-save').click();});
$('nick-modal').addEventListener('click',e=>{if(e.target===$('nick-modal'))$('nick-modal').classList.remove('show');});

$('dd-logout').addEventListener('click',async()=>{
  await remove(ref(db,'presence/'+myUid));
  await remove(ref(db,'typing/'+myUid));
  push(ref(db,'messages'),{type:'system',text:myNick+' é›¢é–‹äº†èŠå¤©å®¤',ts:serverTimestamp()});
  chatInited=false; lastDate='';
  await signOut(auth);
});
</script>
</body>
</html>